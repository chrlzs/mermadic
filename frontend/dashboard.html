<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - Mermadic</title>
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="/nui/nui.css">
</head>
<body>
  <header>
    <div class="container">
      <h1>Mermadic</h1>
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/dashboard.html" class="active">Dashboard</a></li>
          <li><a href="#" id="logout-link">Logout</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="dashboard-header">
      <h2>My Diagrams</h2>
      <button id="create-new-chart" class="nui-button primary">Create New Diagram</button>
    </section>

    <section id="chart-editor" class="chart-editor" style="display: none;">
      <h3 id="editor-title">Create New Diagram</h3>
      <form id="chart-form">
        <input type="hidden" id="chart-id">
        <div class="form-group">
          <label for="chart-title">Title</label>
          <input type="text" id="chart-title" name="chart-title" class="nui-input" required>
        </div>

        <div class="form-group">
          <label for="chart-public">
            <input type="checkbox" id="chart-public" name="chart-public">
            Make diagram public
          </label>
        </div>

        <div class="editor-container">
          <div class="editor-panel">
            <h4>Mermaid Syntax</h4>
            <textarea id="chart-content" class="mermaid-editor" required>graph TD
    A[Start] --> B{Is it working?}
    B -->|Yes| C[Great!]
    B -->|No| D[Debug]
    D --> B</textarea>
          </div>
          <div class="preview-panel">
            <h4>Preview</h4>
            <div id="chart-preview" class="mermaid-preview"></div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="nui-button primary">Save</button>
          <button type="button" id="cancel-edit" class="nui-button secondary">Cancel</button>
        </div>
      </form>
    </section>

    <section id="charts-list" class="charts-list">
      <div id="no-charts-message" style="display: none;">
        <p>You don't have any diagrams yet. Create your first one!</p>
      </div>

      <div id="charts-grid" class="charts-grid">
        <!-- Charts will be loaded here dynamically -->
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2023 Mermadic. All rights reserved.</p>
    </div>
  </footer>

  <script src="/js/mermaid.min.js"></script>
  <script src="/nui/nui.js"></script>
  <script src="/js/auth.js"></script>
  <script src="/js/charts.js"></script>
  <script>
    // Initialize Mermaid with better error handling
    mermaid.initialize({
      startOnLoad: false,
      securityLevel: 'loose',
      theme: 'default',
      logLevel: 'error',
      fontFamily: 'monospace'
    });

    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is logged in via localStorage
      let user = JSON.parse(localStorage.getItem('user'));

      // If no user in localStorage, check if we're coming from Google auth
      if (!user) {
        console.log('No user in localStorage, checking session...');
        // Fetch current user from session
        fetchCurrentUser()
          .then(sessionUser => {
            if (sessionUser) {
              // Store user in localStorage
              localStorage.setItem('user', JSON.stringify(sessionUser));
              user = sessionUser;
              console.log('User found in session, stored in localStorage:', user);
              // Load user's charts
              loadUserCharts();
            } else {
              // No user in session either, redirect to login
              window.location.href = '/login.html';
            }
          })
          .catch(error => {
            console.error('Error fetching current user:', error);
            window.location.href = '/login.html';
          });
      } else {
        // User already in localStorage, load charts
        loadUserCharts();
      }

      // Setup event listeners
      document.getElementById('create-new-chart').addEventListener('click', showChartEditor);
      document.getElementById('cancel-edit').addEventListener('click', hideChartEditor);
      document.getElementById('chart-content').addEventListener('input', updateChartPreview);
      document.getElementById('chart-form').addEventListener('submit', saveChart);

      // Initial preview update
      updateChartPreview();
    });

    function showChartEditor() {
      document.getElementById('charts-list').style.display = 'none';
      document.getElementById('chart-editor').style.display = 'block';
      document.getElementById('editor-title').textContent = 'Create New Diagram';
      document.getElementById('chart-form').reset();
      document.getElementById('chart-id').value = '';
      updateChartPreview();
    }

    function hideChartEditor() {
      document.getElementById('chart-editor').style.display = 'none';
      document.getElementById('charts-list').style.display = 'block';
    }

    function updateChartPreview() {
      const content = document.getElementById('chart-content').value;
      const preview = document.getElementById('chart-preview');

      try {
        // Clear the preview div
        preview.innerHTML = '';

        // Create a div element with class mermaid
        const mermaidDiv = document.createElement('div');
        mermaidDiv.className = 'mermaid';
        mermaidDiv.textContent = content;

        // Append the div element to the preview div
        preview.appendChild(mermaidDiv);

        // Add error handling callback
        mermaid.parseError = function(err, hash) {
          console.error('Mermaid parse error:', err);
          preview.innerHTML = `<div class="error-message">
            <strong>Mermaid Syntax Error:</strong><br>
            ${err}<br><br>
            <strong>Common issues to check:</strong><br>
            - Indentation and whitespace<br>
            - Special characters (try using simple ASCII characters)<br>
            - Missing connections or closing brackets<br>
            - Subgraph syntax (ensure proper nesting)<br>
          </div>`;
        };

        // Render the diagram
        mermaid.init(undefined, mermaidDiv);
      } catch (error) {
        console.error('Error rendering Mermaid diagram:', error);
        preview.innerHTML = `<div class="error-message">
          <strong>Error rendering diagram:</strong><br>
          ${error.message}<br><br>
          <strong>Common issues to check:</strong><br>
          - Indentation and whitespace<br>
          - Special characters (try using simple ASCII characters)<br>
          - Missing connections or closing brackets<br>
          - Subgraph syntax (ensure proper nesting)<br>
        </div>`;
      }
    }

    async function loadUserCharts() {
      try {
        const response = await fetch('/api/charts', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load charts');
        }

        const data = await response.json();
        const chartsGrid = document.getElementById('charts-grid');
        const noChartsMessage = document.getElementById('no-charts-message');

        chartsGrid.innerHTML = '';

        if (data.charts && data.charts.length > 0) {
          noChartsMessage.style.display = 'none';

          data.charts.forEach(chart => {
            const chartCard = document.createElement('div');
            chartCard.className = 'chart-card';

            // Create the card header with title
            const cardHeader = document.createElement('h4');
            cardHeader.textContent = chart.title;
            chartCard.appendChild(cardHeader);

            // Create the chart preview container
            const previewContainer = document.createElement('div');
            previewContainer.className = 'chart-preview-small';

            // Create the mermaid div
            const mermaidDiv = document.createElement('div');
            mermaidDiv.className = 'mermaid';
            mermaidDiv.textContent = chart.content;
            previewContainer.appendChild(mermaidDiv);
            chartCard.appendChild(previewContainer);

            // Create the actions container
            const actionsContainer = document.createElement('div');
            actionsContainer.className = 'chart-actions';
            actionsContainer.innerHTML = `
              <button class="nui-button small edit-chart" data-id="${chart.id}">Edit</button>
              <button class="nui-button small delete-chart" data-id="${chart.id}">Delete</button>
              <button class="nui-button small share-chart" data-id="${chart.share_id}">Share</button>
            `;
            chartCard.appendChild(actionsContainer);

            chartsGrid.appendChild(chartCard);
          });

          // Initialize Mermaid on all chart previews
          mermaid.init(undefined, document.querySelectorAll('.chart-preview-small'));

          // Add event listeners to buttons
          document.querySelectorAll('.edit-chart').forEach(button => {
            button.addEventListener('click', function() {
              editChart(this.getAttribute('data-id'));
            });
          });

          document.querySelectorAll('.delete-chart').forEach(button => {
            button.addEventListener('click', function() {
              deleteChart(this.getAttribute('data-id'));
            });
          });

          document.querySelectorAll('.share-chart').forEach(button => {
            button.addEventListener('click', function() {
              shareChart(this.getAttribute('data-id'));
            });
          });
        } else {
          noChartsMessage.style.display = 'block';
        }
      } catch (error) {
        console.error('Error loading charts:', error);
      }
    }

    async function saveChart(e) {
      e.preventDefault();

      const chartId = document.getElementById('chart-id').value;
      const title = document.getElementById('chart-title').value;
      const content = document.getElementById('chart-content').value;
      const isPublic = document.getElementById('chart-public').checked;

      try {
        let url = '/api/charts';
        let method = 'POST';

        if (chartId) {
          url = `/api/charts/${chartId}`;
          method = 'PUT';
        }

        const response = await fetch(url, {
          method: method,
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ title, content, isPublic })
        });

        if (!response.ok) {
          throw new Error('Failed to save chart');
        }

        hideChartEditor();
        loadUserCharts();
      } catch (error) {
        console.error('Error saving chart:', error);
      }
    }

    async function editChart(chartId) {
      try {
        const response = await fetch(`/api/charts/${chartId}`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to load chart');
        }

        const data = await response.json();
        const chart = data.chart;

        document.getElementById('chart-id').value = chart.id;
        document.getElementById('chart-title').value = chart.title;
        document.getElementById('chart-content').value = chart.content;
        document.getElementById('chart-public').checked = chart.public === 1;
        document.getElementById('editor-title').textContent = 'Edit Diagram';

        showChartEditor();
        updateChartPreview();
      } catch (error) {
        console.error('Error editing chart:', error);
      }
    }

    async function deleteChart(chartId) {
      if (!confirm('Are you sure you want to delete this diagram?')) {
        return;
      }

      try {
        const response = await fetch(`/api/charts/${chartId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Failed to delete chart');
        }

        loadUserCharts();
      } catch (error) {
        console.error('Error deleting chart:', error);
      }
    }

    function shareChart(shareId) {
      const shareUrl = `${window.location.origin}/share.html?id=${shareId}`;

      // Create a temporary input to copy the URL
      const tempInput = document.createElement('input');
      tempInput.value = shareUrl;
      document.body.appendChild(tempInput);
      tempInput.select();
      document.execCommand('copy');
      document.body.removeChild(tempInput);

      alert('Share URL copied to clipboard: ' + shareUrl);
    }

    // Function to fetch current user from session
    async function fetchCurrentUser() {
      try {
        const response = await fetch('/api/users/me');
        if (!response.ok) {
          if (response.status === 401) {
            // Not authenticated
            return null;
          }
          throw new Error('Failed to fetch current user');
        }

        const data = await response.json();
        return data.user;
      } catch (error) {
        console.error('Error fetching current user:', error);
        return null;
      }
    }
  </script>
</body>
</html>
